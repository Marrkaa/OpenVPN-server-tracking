#!/bin/sh /etc/rc.common

START=99
STOP=10

USE_PROCD=1
PROCD_RELOAD_DELAY=5

DEPENDS="openvpn"

start_service() {
	local count=0
	local found_enabled=0
	
	while [ $count -lt 30 ]; do
		for section in $(uci show openvpn 2>/dev/null | grep "\.enable='1'" | cut -d'=' -f1 | cut -d'.' -f2); do
			local mode=$(uci get "openvpn.${section}.mode" 2>/dev/null)
			if [ "$mode" = "server" ]; then
				found_enabled=1
				if pgrep -f "openvpn.*${section}" > /dev/null 2>&1 || pgrep openvpn > /dev/null 2>&1; then
					break 2
				fi
			fi
		done
		
		sleep 1
		count=$((count + 1))
	done
	
	procd_open_instance
	procd_set_param command /usr/bin/lua /usr/lib/lua/api/services/main.lua
	procd_set_param respawn
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_close_instance
}